<!DOCTYPE html>
<html lang="en-us">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		
		
		<meta name="generator" content="Hugo 0.55.4" />
		<title>ë„ì»¤(Docker), AWS Codebuild, CodePipelineì„ í™œìš©í•œ ë ˆì¼ì¦ˆ(Ruby on Rails) ê°œë°œê³¼ ë°°í¬ &middot; Hyunmin Lee</title>
		<link rel="shortcut icon" href="https://qpzm.github.io/images/favicon.ico">
		<link rel="stylesheet" href="https://qpzm.github.io/css/style.css">
		<link rel="stylesheet" href="https://qpzm.github.io/css/highlight.css">

		
		<link rel="stylesheet" href="https://qpzm.github.io/css/font-awesome.min.css">
		

		

		
	</head>

    <body>
       <nav class="main-nav">
	
	
		<a href='https://qpzm.github.io/'> <span class="arrow">â†</span>Home</a>
	
	<a href='https://qpzm.github.io/posts'>Archive</a>
	<a href='https://qpzm.github.io/tags'>Tags</a>
	<a href='https://qpzm.github.io/about'>About</a>

	

	
</nav>


        <section id="wrapper" class="post">
            <article>
                <header>
                    <h1>
                        ë„ì»¤(Docker), AWS Codebuild, CodePipelineì„ í™œìš©í•œ ë ˆì¼ì¦ˆ(Ruby on Rails) ê°œë°œê³¼ ë°°í¬
                    </h1>
                    <h2 class="headline">
                    Mar 13, 2019 12:00
                    Â· 1087 words
                    Â· 6 minute read
                      <span class="tags">
                      
                      
                          
                              <a href="https://qpzm.github.io/tags/docker">Docker</a>
                          
                              <a href="https://qpzm.github.io/tags/aws">AWS</a>
                          
                      
                      
                      </span>
                    </h2>
                </header>
                
                <section id="post-body">
                    

<p>ë„ì»¤ì— ëŒ€í•œ ê°„ëµíˆ ì´í•´í•˜ê³  ë ˆì¼ì¦ˆ ê°œë°œì— ì ìš©í•´ ë´…ë‹ˆë‹¤. ì“°ë‹¤ ë³´ë©´ ê¶ê¸ˆí•´ì§€ë¯€ë¡œ ì›ë¦¬ë³´ë‹¤ëŠ” ì‚¬ìš© ë°©ë²•ì— ì§‘ì¤‘í•©ë‹ˆë‹¤. ğŸ™‹ ë¼ë²¨ì´ ë¶™ì€ ë‚´ìš©ì€ ë„˜ì–´ê°€ë„ ì¢‹ìŠµë‹ˆë‹¤.</p>

<h2 id="1-êµ³ì´-ì™œ">1. êµ³ì´ ì™œ?</h2>

<h3 id="ì‰½ê³ -ë¹ ë¥¸-í™˜ê²½-ì„¤ì •">ì‰½ê³  ë¹ ë¥¸ í™˜ê²½ ì„¤ì •</h3>

<p>ìƒˆ í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í•˜ë©´ ì„¸íŒ…í•˜ë‹¤ í•˜ë£¨ê°€ ë‹¤ ê°€ê³¤ í•œë‹¤. ì´ì œ Docker ë¥¼ ì´ìš©í•˜ë©´ ë‘ ì¤„ë¡œ ëë‚œë‹¤.</p>

<pre><code class="language-bash">docker-compose build
docker-compose up
</code></pre>

<h3 id="ë¶ˆë³€-ë°°í¬-immutable-deployment">ë¶ˆë³€ ë°°í¬ (Immutable deployment)</h3>

<p>ê³¼ê±°ì˜ ë‚˜ëŠ” ì„œë²„ì— ë„ëŒ€ì²´ ë¬´ìŠ¨ ì§“ì„ ë²Œì˜€ëŠ”ê°€?  <code>rvm</code>  <code>nginx</code> ë“± ì˜¨ê°– íŒ¨í‚¤ì§€, ì„¤ì • íŒŒì¼ì˜ í–¥ì—°ì— ì¢Œì ˆí•˜ê³¤ í–ˆë‹¤.</p>

<p>ì‰½ê²Œ ë˜‘ê°™ì€ ì„œë²„ë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆë‹¤ë©´ ì„œë²„ ê´€ë¦¬, ë¡¤ë°±, Scalingì— ìœ ë¦¬í•˜ë‹¤.</p>

<h2 id="2-ë„ì»¤-ë§›ë³´ê¸°">2. ë„ì»¤ ë§›ë³´ê¸°</h2>

<p>ë„ì»¤ëŠ” ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ê°œë°œ, ë°°í¬, ì‹¤í–‰í•˜ê¸° ìœ„í•œ ì˜¤í”ˆì†ŒìŠ¤ í”Œë«í¼ì…ë‹ˆë‹¤.</p>

<p><img src="https://docs.docker.com/storage/storagedriver/images/sharing-layers.jpg" alt="Containers sharing same image" /></p>

<h3 id="ì´ë¯¸ì§€">ì´ë¯¸ì§€</h3>

<p>ëœ¯ê¸° ì „ 3ë¶„ ì¹´ë ˆ. Mysql docker imageë¼ë©´ mysqlì„ ì‹¤í–‰ì‹œí‚¬ ìˆ˜ ìˆê²Œ ì½”ë“œ, ì˜ì¡´ì„± íŒ¨í‚¤ì§€, í™˜ê²½ë³€ìˆ˜ ë“± ëª¨ë“  ê²ƒì´ ì¤€ë¹„ë˜ì–´ ìˆë‹¤. Dockerfileì„ ë¹Œë“œí•´ì„œ ë§Œë“¤ë©° ì—¬ëŸ¬ ê°œì˜ ë ˆì´ì–´ë¡œ ì´ë¤„ì§„ë‹¤.</p>

<h3 id="ì»¨í…Œì´ë„ˆ">ì»¨í…Œì´ë„ˆ</h3>

<p>ì „ìë ˆì¸ì§€ì— ëŒë¦° 3ë¶„ ì¹´ë ˆ. ì´ë¯¸ì§€ë¥¼ ì‹¤í–‰ì‹œí‚¤ë©´ ì»¨í…Œì´ë„ˆê°€ ëœë‹¤. Mysql ì´ë¯¸ì§€ì˜ ì»¨í…Œì´ë„ˆëŠ” ì‹¤ì œë¡œ Mysqlì„ ì‚¬ìš©ê°€ëŠ¥í•˜ë‹¤. ë„ì»¤ ì´ë¯¸ì§€ì— ìƒˆ Read/Write layerë¥¼ ì˜¬ë ¤ì„œ ë§Œë“¤ì–´ì§€ê³  ì¢…ë£Œ ì‹œ í•´ë‹¹ ë ˆì´ì–´ëŠ” ì§€ì›Œì§„ë‹¤.</p>

<h3 id="ê¸°ë³¸-ëª…ë ¹ì–´">ê¸°ë³¸ ëª…ë ¹ì–´</h3>

<pre><code class="language-bash">docker run docker/whalesay cowsay &quot;ë‚œë‹¤ ê³ ë˜?&quot;
docker run -it docker/whalesay /bin/sh
docker ps # ì‹¤í–‰ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ëª©ë¡
docker ps -a # ëª¨ë“  ì»¨í…Œì´ë„ˆ ëª©ë¡
docker stop &lt;container-id&gt;
docker rm &lt;container-id&gt; # ì»¨í…Œì´ë„ˆ ì‚­ì œ
docker image ls # ì´ë¯¸ì§€ ëª©ë¡
docker rmi &lt;image-id&gt; # ì´ë¯¸ì§€ ì‚­ì œ
docker system prune # ì•ˆ ì“°ëŠ” ì»¨í…Œì´ë„ˆ, ì´ë¯¸ì§€ ëª¨ë‘ ì‚­ì œ
</code></pre>

<h3 id="ë ˆì¼ì¦ˆ-ë„ì»¤-íŒŒì¼-ì˜ˆì‹œ">ë ˆì¼ì¦ˆ ë„ì»¤ íŒŒì¼ ì˜ˆì‹œ</h3>

<pre><code class="language-dockerfile">FROM ruby:2.5.3 # ubuntu with ruby 2.5.3

RUN apt-get update -qq &amp;&amp; \
    apt-get install -y build-essential libpq-dev nodejs imagemagick &amp;&amp; \
    rm -rf /var/lib/apt/lists/*

ENV RAILS_ROOT /var/www/app
RUN mkdir -p $RAILS_ROOT

WORKDIR $RAILS_ROOT

COPY Gemfile* ./
RUN gem install bundler -v '1.16.4' \
    &amp;&amp; bundler config --global frozen 1
RUN bundle install

VOLUME $RAILS_ROOT

EXPOSE 3000

CMD bundle exec rails db:migrate &amp;&amp; bundle exec puma -C config/puma.rb
</code></pre>

<h4 id="volume">VOLUME</h4>

<p>ë³¼ë¥¨ì€ ì™¸ë¶€ ì €ì¥ ì¥ì¹˜ì²˜ëŸ¼ í˜¸ìŠ¤íŠ¸ì˜ ì €ì¥ê³µê°„ì„ ì“°ê¸° ìœ„í•´. DB ì €ì¥ì— í”íˆ ì‚¬ìš©í•˜ëŠ”ë° ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.</p>

<ul>
<li>ì»¨í…Œì´ë„ˆë¥¼ ì§€ì›Œë„ ë³¼ë¥¨ì— ì €ì¥í•œ ë°ì´í„°ëŠ” ë‚¨ì•„ìˆë‹¤.</li>
<li>ë³¼ë¥¨ì— ê¸°ë¡í•˜ë©´ ì´ë¯¸ì§€ í¬ê¸°ê°€ ëŠ˜ì–´ë‚˜ì§€ ì•ŠëŠ”ë‹¤.</li>
</ul>

<p>ë‹¨ dockerfileì—ì„œ VOLUME ëª…ë ¹ì–´ëŠ” mount point, ì¦‰ ë¹ˆ í´ë”ë§Œ ë§Œë“ ë‹¤. <code>docker run -v &lt;host_path&gt;:&lt;container_path&gt;</code> ë¥¼ í†µí•´ ì‹¤ì œë¡œ ë§ˆìš´íŠ¸í•  ìˆ˜ ìˆë‹¤.</p>

<h4 id="expose">EXPOSE</h4>

<p>docker run í•  ë•Œ í•´ë‹¹ í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ë¼ëŠ” í‘œì‹œ.
ì‹¤íš¨ëŠ” ì—†ê³  ì‚¬ìš©ìì—ê²Œ ë‚¨ê¸°ëŠ” ì£¼ì„ì´ë‹¤. (AWS ë°°í¬í•˜ëŠ” í”Œë«í¼ì— ë”°ë¼ ì´ í‘œì‹œë¥¼ í™œìš©í•˜ëŠ” ê²½ìš°ë„ ìˆë‹¤)</p>

<p><strong>Tip</strong></p>

<blockquote>
<p>In Docker 1.10 and higher, only <code>RUN</code>, <code>COPY</code>, and <code>ADD</code> instructions create layers. Other instructions create temporary intermediate images, and no longer directly increase the size of the build.</p>
</blockquote>

<p><a href="https://docs.docker.com/v17.09/engine/userguide/eng-image/dockerfile_best-practices/#minimize-the-number-of-layers">https://docs.docker.com/v17.09/engine/userguide/eng-image/dockerfile_best-practices/#minimize-the-number-of-layers</a></p>

<p><code>RUN</code>, <code>COPY</code>, <code>ADD</code> ì„¸ ëª…ë ¹ì–´ëŠ” ì´ë¯¸ì§€ ë ˆì´ì–´ë¥¼ ë§Œë“ ë‹¤. ë¹Œë“œí•  ë•Œ ì•„ë˜ ë ˆì´ì–´ê°€ ë³€ê²½ëœ ê²½ìš°, ê·¸ ìœ„ ë ˆì´ì–´ë“¤ì„ ì „ë¶€ ìƒˆë¡œ ë¹Œë“œí•˜ë¯€ë¡œ ëª…ë ¹ì–´ ë°°ì¹˜ì— ìœ ì˜í•˜ì.</p>

<p>ğŸ™‹ğŸ¼â€â™€ï¸Dockerfileë¶€í„° ì§ì ‘ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•´ ë³´ì: <a href="https://docs.docker.com/get-started/part2/">ê³µì‹ íŠœí† ë¦¬ì–¼</a></p>

<h3 id="ì •ë¦¬">ì •ë¦¬</h3>

<blockquote>
<p>ì»¨í…Œì´ë„ˆëŠ” ì¶”ìƒí™”ëœ ì–´í”Œë¦¬ì¼€ì´ì…˜ì´ë‹¤.</p>
</blockquote>

<h4 id="ì¶”ìƒí™”-abstraction">ì¶”ìƒí™” (Abstraction)</h4>

<p>ì¤‘ìš”í•œ ê²ƒë§Œ ë‚¨ê¸°ëŠ” ê²ƒ. 3ë¶„ ì¹´ë ˆë„ ì¹´ë ˆë‹¤.</p>

<ul>
<li>ìˆ«ì: 1000ì›ì„ ë°›ìœ¼ë©´ 100ì› ì§œë¦¬ê°€ ëª‡ ê°œì¸ì§€ ì‹ ê²½ì“°ì§€ ì•ŠëŠ”ë‹¤.</li>
<li>OSì˜ í•˜ë“œì›¨ì–´ ì¶”ìƒí™”: ì•ˆë“œë¡œì´ë“œ ì•±ì€ ë‹¤ì–‘í•œ ê¸°ê¸°ì—ì„œ ì‹¤í–‰ëœë‹¤.</li>
</ul>

<h4 id="vm-vs-container">VM vs Container</h4>

<p><img src="https://www.docker.com/sites/default/files/d8/2018-11/docker-containerized-and-vm-transparent-bg.png" alt="img" /></p>

<p><a href="https://www.docker.com/resources/what-container">ë„ì»¤ ê³µì‹ë¬¸ì„œ</a>ì— ë”°ë¥´ë©´ ì»¨í…Œì´ë„ˆëŠ” ì½”ë“œì™€ ì˜ì¡´ íŒ¨í‚¤ì§€ë¥¼ í¬í•¨í•œ ì–´í”Œë¦¬ì¼€ì´ì…˜, ì¦‰ OS ì»¤ë„ ìœ„ì—ì„œ ì‹¤í–‰ë˜ëŠ” í”„ë¡œê·¸ë¨ì„ ì¶”ìƒí™”í•œë‹¤. ë°˜ë©´, ê°€ìƒë¨¸ì‹ ì€ ì»´í“¨í„° í•˜ë“œì›¨ì–´ë¥¼ ì¶”ìƒí™”í•œë‹¤. ë„ì»¤ ì»¨í…Œì´ë„ˆë“¤ì€ OS ì»¤ë„ì„ ê³µìœ í•˜ê¸° ë•Œë¬¸ì— ë” ì ì€ ìš©ëŸ‰ì„ ì°¨ì§€í•œë‹¤.</p>

<p><strong>ì ê¹!</strong></p>

<p>ë„ì»¤ëŠ” namespace(ë…ë¦½ëœ í”„ë¡œì„¸ìŠ¤ ê³µê°„), cgroup(ë¦¬ì†ŒìŠ¤ ì œí•œ) ë“±ì˜ ë¦¬ëˆ…ìŠ¤ì˜ ê¸°ëŠ¥ì„ í™œìš©í•´ì„œ ë§Œë“¤ì–´ì¡Œë‹¤. ë”°ë¼ì„œ Docker for macì€ ë¦¬ëˆ…ìŠ¤ë¥¼ ëŒë¦¬ê¸° ìœ„í•œ ê°€ìƒë¨¸ì‹ ì„ ì¶”ê°€ë¡œ ì„¤ì¹˜í•œë‹¤.</p>

<h2 id="3-docker-compose">3. docker-compose</h2>

<p><code>docker-compose.yml</code> íŒŒì¼ì„ ì •ì˜í•˜ê³  í•´ë‹¹ íŒŒì¼ì´ ìˆëŠ” í´ë”ì—ì„œ <code>docker-compose ëª…ë ¹ì–´</code> ë¥¼ ì…ë ¥í•˜ë©´ ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆë¥¼ í•œ ë²ˆì— ê´€ë¦¬í•˜ê³  ì˜µì…˜ì„ ìƒëµí•  ìˆ˜ ìˆì–´ í¸ë¦¬í•˜ë‹¤.</p>

<h3 id="ê¸°ë³¸-ëª…ë ¹ì–´-1">â­ï¸ ê¸°ë³¸ ëª…ë ¹ì–´</h3>

<h4 id="ì´ë¯¸ì§€-ë¹Œë“œ-í›„-ì»¨í…Œì´ë„ˆ-ì‹¤í–‰">ì´ë¯¸ì§€ ë¹Œë“œ í›„ ì»¨í…Œì´ë„ˆ ì‹¤í–‰</h4>

<ul>
<li>í•œ ë²ˆë„ ë¹Œë“œí•œ ì ì´ ì—†ì–´ ì•„ì§ ì´ë¯¸ì§€ê°€ ì—†ì„ ë•Œ</li>
<li>Gemfileì„ ìˆ˜ì •í–ˆì„ ë•Œ</li>
</ul>

<pre><code class="language-bash">docker-compose build
docker-compose up -d
docker-compose logs -f app
</code></pre>

<h4 id="í„°ë¯¸ë„-ëª…ë ¹ì–´-ì…ë ¥">í„°ë¯¸ë„ ëª…ë ¹ì–´ ì…ë ¥</h4>

<pre><code class="language-bash">$ docker-compose exec app bash
root@35b0e137ef35:/var/www/app# e.g. bundle exec rails db:migrate
</code></pre>

<h4 id="ì»¨í…Œì´ë„ˆ-ì¢…ë£Œ">ì»¨í…Œì´ë„ˆ ì¢…ë£Œ</h4>

<pre><code>docker-compose down
</code></pre>

<p>ğŸ™‹ <code>docker-compose</code>ë¥¼ ì´ìš©í•´ ë ˆì¼ì¦ˆ, postgresqlì„ ì‹¤í–‰í•´ë³´ì: <a href="https://docs.docker.com/compose/rails/">https://docs.docker.com/compose/rails/</a></p>

<h3 id="docker-compose-yml-êµ¬ì„±">ğŸ™‹ <code>docker-compose.yml</code> êµ¬ì„±</h3>

<p>ì˜ˆì‹œ ë ˆì¼ì¦ˆ í”„ë¡œì íŠ¸ì˜  <code>/docker-compose.yml</code> ì„ ì‚´í´ë³´ì.</p>

<pre><code class="language-yaml">version: '3.2' # use compose format v3
services:
  app:
    build:
      context: .
      dockerfile: ./docker/app/Dockerfile
      cache_from:
        - ${AWS_ECR_REPO}/rails:1.0.3
    image: ${AWS_ECR_REPO}/rails:1.0.3
    volumes:
      - ./:/var/www/app
      - ./config/database-docker.yml:/var/www/app/config/database.yml
    expose:
      - 3000
    environment:
      - RAILS_ENV=development
    depends_on:
      - db # ì‹œì‘ ìˆœì„œë¥¼ ì¡°ì •, ë‹¨ í•´ë‹¹ containerì˜ started ìƒíƒœë§Œ ë³´ì¥, ë‚´ë¶€ì  ì¤€ë¹„ ì—¬ë¶€ëŠ” ëª¨ë¦„.

  db:
    image: mysql:5.7
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    volumes:
      - ./db/development:/var/lib/mysql
    expose:
      - 3306
    environment:
      MYSQL_ROOT_PASSWORD: xxx
      MYSQL_DATABASE: xxx

  web:
    build:
      context: ./docker/web/
      cache_from:
        - ${AWS_ECR_REPO}/nginx:1.0.0
    image: ${AWS_ECR_REPO}/nginx:1.0.0
    ports:
      - 80:80
      - 4000:3000 # dev
    depends_on:
      - app
</code></pre>

<h2 id="4-staging-ì„œë²„ë¡œ-ë°°í¬">4. Staging ì„œë²„ë¡œ ë°°í¬</h2>

<h3 id="ë°°í¬-ê³¼ì •">â­ï¸ ë°°í¬ ê³¼ì •</h3>

<ol>
<li><p><code>dev</code> ë¸Œëœì¹˜ì—ì„œ <code>docker-compose.yml</code>ê³¼ <code>Dockerrun.aws.json</code> ì˜ ë ˆì¼ì¦ˆ ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ìƒˆ ë¦´ë¦¬ì¦ˆ ë²„ì „ê³¼ ë™ì¼í•˜ê²Œ ì—…ë°ì´íŠ¸ í›„ ì»¤ë°‹</p></li>

<li><p><code>staging</code> ë¸Œëœì¹˜ë¡œ pull request &amp; squash and merge</p></li>

<li><p>AWS Codebuild ì™€ Codepipelineì— ì˜í•´ ElasticBeanstalkì— ìë™ ë°°í¬</p></li>
</ol>

<p><code>staging</code> ë¸Œëœì¹˜ì— ëŒ€í•œ í‘¸ì‹œ ê¶Œí•œì„ ì œí•œí•˜ë©´ ë¬´ë¶„ë³„í•œ ë°°í¬ë¥¼ ë§‰ì„ ìˆ˜ ìˆë‹¤.</p>

<h3 id="codebuild">Codebuild</h3>

<p>ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³  ì´ë¯¸ì§€ ì €ì¥ì†Œì— ì—…ë¡œë“œ</p>

<p>ë¡œì»¬ì— AWS CLIê°€ ì„¤ì¹˜ë˜ì–´ ìˆë‹¤ë©´ ì•„ë˜ì˜ ìˆœì„œë¡œ ì´ë¯¸ì§€ ì €ì¥ì†Œì— í‘¸ì‹œí•  ìˆ˜ ìˆë‹¤.</p>

<ol>
<li><code>aws configure</code> ëª…ë ¹ì–´ë¥¼ í†µí•´ í•´ë‹¹ ì €ì¥ì†Œì— ì—…ë¡œë“œ ê¶Œí•œì´ ìˆëŠ” ìœ ì €ë¡œ ë¡œê·¸ì¸</li>
<li>ì•„ë˜ build scriptì˜ <code>-</code> ë‹¤ìŒì— ë‚˜ì˜¤ëŠ” ëª…ë ¹ì–´ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì…ë ¥</li>
</ol>

<p><code>/buildspec.yml</code></p>

<pre><code class="language-yaml">version: 0.2 # build spec version

env:
  variables:
    AWS_DEFAULT_REGION: &quot;ap-northeast-2&quot;

phases:
  pre_build:
    commands:
      - echo Logging into Amazon ECR...
      - $(aws ecr get-login --region $AWS_DEFAULT_REGION --no-include-email)
      - echo Pulling Docker Images for cache...
      - docker-compose pull --ignore-pull-failures -q
  build:
    commands:
      - docker-compose build
  post_build:
    commands:
      - docker-compose push

artifacts:
  files:
    - './**/*'
</code></pre>

<h3 id="codepipeline">Codepipeline</h3>

<p>Github ì†ŒìŠ¤ì½”ë“œë¥¼ Codebuildì— ì „ë‹¬í•˜ê³  ElasticBeanstalkì— ë°°í¬</p>

<p><img src="https://user-images.githubusercontent.com/18223805/54255510-bc206d80-459b-11e9-983f-78aa42b95697.png" alt="image-20190313041603062" /></p>

<h3 id="aws-elasticbeanstalk-ì„¸ë¶€-ë‚´ìš©">ğŸ™‹ğŸ¼â€â™€ï¸ AWS ElasticBeanstalk ì„¸ë¶€ ë‚´ìš©</h3>

<p>AWS ElasticBeanstalk Multicontainer docker í™˜ê²½ì„ ì‚¬ìš©í•œë‹¤. ì´ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ì»¨í…Œì´ë„ˆ ê´€ë¦¬ ì„œë¹„ìŠ¤ì¸ Elastic Container Serviceë¥¼ ì´ìš©í•˜ë©° <code>docker-compose.yml</code> ê³¼ ìœ ì‚¬í•œ ì•„ë˜ì˜ ì„¤ì •íŒŒì¼ì´ í•„ìš”í•˜ë‹¤.</p>

<p><code>/Dockerrun.aws.json</code></p>

<pre><code class="language-json">{
  &quot;AWSEBDockerrunVersion&quot;: 2,
  &quot;containerDefinitions&quot;: [
    {
      &quot;environment&quot;: [
        {
          &quot;name&quot;: &quot;RAILS_ENV&quot;,
          &quot;value&quot;: &quot;production&quot;
        }
      ],
      &quot;essential&quot;: true,
      &quot;memory&quot;: 512,
      &quot;image&quot;: &quot;386640523397.dkr.ecr.ap-northeast-2.amazonaws.com/rails:1.0.3&quot;,
      &quot;mountPoints&quot;: [
        {
          &quot;containerPath&quot;: &quot;/var/www/app&quot;,
          &quot;sourceVolume&quot;: &quot;Performance_Plus_Rails&quot;
        },
        {
          &quot;containerPath&quot;: &quot;/var/www/app/config/database.yml&quot;,
          &quot;sourceVolume&quot;: &quot;Performance_Plus_Rails_DB_Config&quot;
        }
      ],
      &quot;name&quot;: &quot;app&quot;
    },
    {
      &quot;essential&quot;: true,
      &quot;memory&quot;: 512,
      &quot;image&quot;: &quot;386640523397.dkr.ecr.ap-northeast-2.amazonaws.com/nginx:1.0.0&quot;,
      &quot;mountPoints&quot;: [
        {
          &quot;containerPath&quot;: &quot;/var/www/app&quot;,
          &quot;sourceVolume&quot;: &quot;Performance_Plus_Rails&quot;
        }
      ],
      &quot;links&quot;: [
        &quot;app&quot;
      ],
      &quot;name&quot;: &quot;web&quot;,
      &quot;portMappings&quot;: [
        {
          &quot;containerPort&quot;: 80,
          &quot;hostPort&quot;: 80
        }
      ]
    }
  ],
  &quot;volumes&quot;: [
    {
      &quot;name&quot;: &quot;Performance_Plus_Rails&quot;,
      &quot;host&quot;: {
        &quot;sourcePath&quot;: &quot;/var/app/current/&quot; # elasticbeanstalkê°€ ê¸°ë³¸ìœ¼ë¡œ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ëŠ” ìœ„ì¹˜
      }
    },
    {
      &quot;name&quot;: &quot;Performance_Plus_Rails_DB_Config&quot;,
      &quot;host&quot;: {
        &quot;sourcePath&quot;: &quot;/var/app/current/config/database-docker.yml&quot;
      }
    }
  ]
}
</code></pre>

<h4 id="links">links</h4>

<p>docker-composeëŠ” ìë™ìœ¼ë¡œ ì»¨í…Œì´ë„ˆ ì´ë¦„ì„ ì´ìš©í•´ ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆì— ì ‘ì†í•  ìˆ˜ ìˆê²Œ ë„ì™€ì¤€ë‹¤.</p>

<p><code>/docker/web/nginx.conf</code> ì˜ ì¼ë¶€</p>

<pre><code class="language-nginx">upstream rails_app {
  server app:3000; # app is defined in Dockerrun.aws.json &quot;link&quot;: [&quot;app&quot;]
}
</code></pre>

<p>ì¶”í›„ <a href="https://docs.docker.com/network/links/">deprecated ì˜ˆì •</a>ì´ë‹ˆ <code>network</code> ì˜µì…˜ìœ¼ë¡œ ë°”ê¿€ ê³„íš. ìì„¸í•œ ì˜µì…˜ ì„¤ëª…ì€ <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definition_parameters.html">Task Definition Parameters - Amazon Elastic Container Service</a> ì„ ì°¸ì¡°í•˜ì.</p>

<h4 id="q-db-ì´ë¯¸ì§€ëŠ”-ì–´ë””ë¡œ-ê°”ë‚˜ìš”">Q. db ì´ë¯¸ì§€ëŠ” ì–´ë””ë¡œ ê°”ë‚˜ìš”?</h4>

<p>DBëŠ” rdsë¡œ ìš´ì˜í•˜ë¯€ë¡œ í•„ìš”ì—†ë‹¤!</p>

<h2 id="ê²°ë¡ ">ê²°ë¡ </h2>

<p>â­ï¸ ë§Œ ìµíˆê³  ì“°ë©´ì„œ ì°¾ì•„ë³´ì.</p>

<h2 id="reference">Reference</h2>

<p><strong>2. ë„ì»¤ ë§›ë³´ê¸°</strong></p>

<p>ë„ì»¤ì˜ ì •ì˜, ì›ë¦¬ <a href="https://docs.docker.com/engine/docker-overview/">https://docs.docker.com/engine/docker-overview/</a></p>

<p>Dockerfileë¶€í„° ë„ì»¤ í—ˆë¸Œì— í‘¸ì‹œê¹Œì§€ <a href="https://docs.docker.com/get-started/part2/">Get Started, Part 2: Containers | Docker Documentation</a></p>

<p>Dockerfile ì‘ì„± ì‹œ ìœ ì˜ì‚¬í•­ <a href="https://docs.docker.com/v17.09/engine/userguide/eng-image/dockerfile_best-practices/">https://docs.docker.com/v17.09/engine/userguide/eng-image/dockerfile_best-practices/</a></p>

<p>Layer ê´€ì ì—ì„œ ë³¸ ì´ë¯¸ì§€ì™€ ì»¨í…Œì´ë„ˆ <a href="https://docs.docker.com/storage/storagedriver/">https://docs.docker.com/storage/storagedriver/</a></p>

<p>ì»¨í…Œì´ë„ˆëŠ” ì–´í”Œë¦¬ì¼€ì´ì…˜ì˜ ì¶”ìƒí™”</p>

<ul>
<li><a href="https://www.docker.com/resources/what-container">What is a Container? | Docker</a></li>
<li><a href="https://blog.docker.com/2016/03/containers-are-not-vms/">Containers are not VMs - Docker Blog</a></li>
</ul>

<p>namespaceì™€ cgroup <a href="https://tech.ssut.me/what-even-is-a-container/">https://tech.ssut.me/what-even-is-a-container/</a></p>

<p><strong>3. docker-compose</strong></p>

<ul>
<li><a href="https://docs.docker.com/compose/compose-file/">ëª…ë ¹ì–´ docs</a></li>
<li><a href="https://docs.docker.com/compose/rails/">docker-composeë¥¼ ì´ìš©í•œ ë ˆì¼ì¦ˆ, postgresql ì‹¤í–‰</a></li>
</ul>

<p><strong>4, Staging ì„œë²„ë¡œ ë°°í¬</strong></p>

<p><a href="https://docs.aws.amazon.com/ko_kr/elasticbeanstalk/latest/dg/create_deploy_docker_ecs.html">AWS ElasticBeanstalk Multicontainer docker í™˜ê²½ íŠœí† ë¦¬ì–¼</a></p>

<p><code>Dockerrun.aws.json</code> ì˜ ì„¤ì • ì˜µì…˜ <a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definition_parameters.html">Task Definition Parameters - Amazon Elastic Container Service</a></p>

<p>ë„ì»¤ ì „ë°˜ì— ëŒ€í•œ í•œê¸€ ìë£Œ <a href="http://pyrasis.com/docker.html">http://pyrasis.com/docker.html</a></p>

                </section>
            </article>

            

            
                <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'hyunmin'; 

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

            

            

            <footer id="footer">
    
        <div id="social">

	
	
    <a class="symbol" href="https://www.facebook.com/hyunminyi">
        <i class="fa fa-facebook-square"></i>
    </a>
    
    <a class="symbol" href="https://www.github.com/qpzm">
        <i class="fa fa-github-square"></i>
    </a>
    


</div>

    
    <p class="small">
    
       Â© Copyright 2020 <i class="fa fa-heart" aria-hidden="true"></i> 
    
    </p>
    <p class="small">
        Powered by <a href="http://www.gohugo.io/">Hugo</a> Theme By <a href="https://github.com/nodejh/hugo-theme-cactus-plus">nodejh</a>
    </p>
</footer>

        </section>

        <script src="https://qpzm.github.io/js/jquery-3.3.1.min.js"></script>
<script src="https://qpzm.github.io/js/main.js"></script>
<script src="https://qpzm.github.io/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>







    </body>
</html>
